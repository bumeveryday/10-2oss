<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Music CRUD Page</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #music-list { margin-top: 20px; }
        #music-list li {
            border: 1px solid #ccc;
            padding: 12px 15px; 
            margin-bottom: 10px;
            list-style: none; 
            line-height: 1.6; 
        }
        
        .music-item button { margin-left: 5px; }

    </style>
</head>
<body>

    <h1>bgm list</h1>

    <button type="button" class="btn btn-primary" id="openAddModalBtn">
      새 음악 추가
    </button>

    <h2>음악 목록</h2>
    <div id="music-list">
        <p>로딩 중...</p> 
    </div>

    <div class="modal fade" id="musicFormModal" tabindex="-1" aria-labelledby="musicModalTitle" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="musicModalTitle">새 음악 추가</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            
            <form id="add-form">
                <div>
                    <label for="title" class="form-label">제목:</label>
                    <input type="text" id="title" class="form-control" required>
                </div>
                <div class="mt-2">
                    <label for="album" class="form-label">앨범:</label>
                    <input type="text" id="album" class="form-control" required>
                </div>
                <div class="mt-2">
                    <label for="mood" class="form-label">분위기:</label>
                    <input type="text" id="mood" class="form-control" required>
                </div>
                <div class="mt-2">
                    <label for="artist" class="form-label">아티스트:</label>
                    <input type="text" id="artist" class="form-control" required>
                </div>
                </form>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            <button type="submit" id="addButton" form="add-form" class="btn btn-primary">추가하기</button>
          </div>
        </div>
      </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentEditId = null;
    let musicModal; // 모달 인스턴스를 저장할 변수
    let modalTitle; // 모달 제목 DOM

    window.onload = function () {
        let addMusicForm = document.getElementById("add-form");
        
        // 1. 모달 인스턴스 및 제목 DOM 초기화
        const musicModalElement = document.getElementById('musicFormModal');
        musicModal = new bootstrap.Modal(musicModalElement);
        modalTitle = document.getElementById('musicModalTitle');
        
        // 폼 제출 시 handleFormSubmit 함수 하나만 호출하도록 설정
        addMusicForm.addEventListener("submit", handleFormSubmit);

        // 2. '새 음악 추가' 버튼 클릭 이벤트
        document.getElementById('openAddModalBtn').addEventListener('click', () => {
            currentEditId = null; // 추가 모드로 설정
            modalTitle.textContent = "새 음악 추가"; // 모달 제목 변경
            document.getElementById("addButton").textContent = "추가하기"; // 버튼 텍스트 변경
            document.getElementById("add-form").reset(); // 폼 초기화
            musicModal.show(); // 모달 띄우기
        });
        
        // 페이지가 켜지자마자 목록 자동 로드
        getMusic();
    }

    // 폼 제출을 관리하는 메인 함수 (변경 없음)
    function handleFormSubmit(event) {
        event.preventDefault(); // 폼 새로고침 방지

        if (currentEditId === null) {
            createMusicLogic();
        } else {
            updateMusicLogic(currentEditId);
        }
    }

    // (R) Read: 목록 가져오기 (GET) (변경 없음)
    function getMusic(){ 
        let contents = document.getElementById("music-list");
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "https://69108baf7686c0e9c20ae745.mockapi.io/musics");
        xhr.setRequestHeader("content-type", "application/json");
        xhr.send();
        xhr.onload = () => {
            if (xhr.status === 200) {
                const res = JSON.parse(xhr.response);                   
                contents.innerHTML = makeList(res);
            } else {
                console.log(xhr.status, xhr.statusText);
            }
        }
    }

    // (R) Read 일부: 목록 HTML 생성
    function makeList(data) {
        let str = "<ul>";
        data.forEach(item => {
            // li 태그에 클래스를 추가하여 CSS가 적용되게 할 수 있습니다.
            str += `
                <li data-id="${item.id}">
                    ${item.title} (${item.mood}) from ${item.album}, by ${item.artist}
                    <button class="btn btn-danger btn-sm" onclick="deleteMusic('${item.id}')">삭제</button>
                    <button class="btn btn-warning btn-sm" onclick="modifyMusic('${item.id}')">수정</button>
                </li>
            `;
        });
        str += "</ul>";
        return str;
    }

    
    // (C) Create: 새 음악 추가 로직
    function createMusicLogic() {
        // ... (내부 로직은 변경 없음)
        let titleInput = document.getElementById("title");
        let albumInput = document.getElementById("album");
        let moodInput = document.getElementById("mood");
        let artistInput = document.getElementById("artist");
        let titleValue = titleInput.value.trim();
        let albumValue = albumInput.value.trim();
        let moodValue = moodInput.value.trim();
        let artistValue = artistInput.value.trim();
        if (!titleValue || !albumValue || !moodValue || !artistValue) {
            alert("모든 필드를 채워주세요!");
            return;
        }
        const data = { title: titleValue, album: albumValue, mood: moodValue, artist: artistValue };

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "https://69108baf7686c0e9c20ae745.mockapi.io/musics");
        xhr.setRequestHeader("content-type", "application/json; charset=UTF-8")
        xhr.send(JSON.stringify(data));
        
        xhr.onload = () => {
            if (xhr.status === 201) {
                // ... (폼 비우는 로직은 reset()이 대신하므로 제거해도 됨)
                getMusic(); // 목록 새로고침
                musicModal.hide(); // 3. 성공 시 모달 닫기
            } else {
                console.log(xhr.status, xhr.statusText);
            }
        }
    }


    // (D) Delete: 음악 삭제 (변경 없음)
    function deleteMusic(id) {
        if (!confirm("정말로 ID: " + id + " 음악을 삭제하시겠습니까?")) {
            return;
        }
        const xhr = new XMLHttpRequest();
        xhr.open("DELETE", `https://69108baf7686c0e9c20ae745.mockapi.io/musics/${id}`);
        xhr.send();
        xhr.onload = () => {
            if (xhr.status === 200) {
                console.log("삭제 성공!");
                getMusic(); // 목록 새로고침
            } else {
                console.error("삭제 실패:", xhr.status, xhr.statusText);
            }
        }
    }


    // (U) Update - 1단계: '수정' 버튼 클릭 시
    function modifyMusic(id) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `https://69108baf7686c0e9c20ae745.mockapi.io/musics/${id}`);
        xhr.send();

        xhr.onload = () => {
            if (xhr.status === 200) {
                const item = JSON.parse(xhr.response);

                // 1. 폼에 기존 데이터 채우기
                document.getElementById("title").value = item.title;
                document.getElementById("album").value = item.album;
                document.getElementById("mood").value = item.mood;
                document.getElementById("artist").value = item.artist;

                // 2. '수정 모드'로 상태 변경 (ID 저장)
                currentEditId = item.id;

                // 3. 모달 제목 및 버튼 텍스트 변경
                modalTitle.textContent = "음악 수정";
                document.getElementById("addButton").textContent = "수정하기";
                
                // 4. 모달 띄우기 (기존 스크롤 기능 대체)
                musicModal.show();

            } else {
                console.error("수정할 데이터를 불러오는 데 실패했습니다.", xhr.status, xhr.statusText);
            }
        }
    }

    // (U) Update - 2단계: '수정하기' 버튼 클릭 시
    function updateMusicLogic(id) {
        // ... (내부 로직은 변경 없음)
        let titleInput = document.getElementById("title");
        let albumInput = document.getElementById("album");
        let moodInput = document.getElementById("mood");
        let artistInput = document.getElementById("artist");
        let titleValue = titleInput.value.trim();
        let albumValue = albumInput.value.trim();
        let moodValue = moodInput.value.trim();
        let artistValue = artistInput.value.trim();
        if (!titleValue || !albumValue || !moodValue || !artistValue) {
            alert("모든 필드를 채워주세요!");
            return;
        }
        const data = { title: titleValue, album: albumValue, mood: moodValue, artist: artistValue };

        const xhr = new XMLHttpRequest();
        xhr.open("PUT", `https://69108baf7686c0e9c20ae745.mockapi.io/musics/${id}`);
        xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
        xhr.send(JSON.stringify(data));

        xhr.onload = () => {
            if (xhr.status === 200) {
                // ... (폼 비우기 및 상태/버튼 복귀 로직은 'openAddModalBtn' 핸들러가 대신함)
                getMusic(); // 목록 새로고침
                musicModal.hide(); // 5. 성공 시 모달 닫기
            } else {
                console.error("수정 실패:", xhr.status, xhr.statusText);
            }
        }
    }
</script>

</body>
</html>